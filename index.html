<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Travel Matrix Timeline Test</title>
  <style>
    body { font-family: sans-serif; }
    #matrixSVG { width:200px; height:200px; border:1px solid #333; margin:10px 0; }
    input[type=range] { width: 100px; }
    #now { margin:10px 0; font-weight:bold; }
  </style>
</head>
<body>
  <h2>Timeline Test</h2>
  <textarea id="csv" rows="5" cols="60" placeholder="Paste your timeline CSV data here"></textarea><br>
  <button id="btnLoadCSV">Load CSV</button>
  <button id="btnPlay">Play</button>
  <button id="btnPause">Pause</button>
  Speed: <input id="playSpeed" type="number" value="1" min="1" max="5"><br>
  <svg id="matrixSVG"></svg>
  <div>
    <label>D: <input id="d" type="range" min="0" max="2" step="0.01"><span id="vd"></span></label><br>
    <label>Mu: <input id="mu" type="range" min="0" max="2" step="0.01"><span id="vmu"></span></label><br>
    <label>S: <input id="s" type="range" min="0" max="2" step="0.01"><span id="vs"></span></label><br>
    <label>Tau: <input id="tau" type="range" min="0" max="2" step="0.01"><span id="vtau"></span></label><br>
    <label>K: <input id="k" type="range" min="0" max="2" step="0.01"><span id="vk"></span></label>
  </div>
  <div id="now"></div>
  <script>
window.addEventListener('DOMContentLoaded', function () {
  const setVar = (name, val) => document.documentElement.style.setProperty(name, val);
  const fmt = x => Number(x).toFixed(2);
  const q = id => document.getElementById(id);

  function bind(id, cssVar, labelId){
    const el=q(id), lab=q(labelId);
    const update=()=>{ setVar(`--${cssVar}`, el.value); lab.textContent=fmt(el.value); };
    el.addEventListener('input', update); update();
  }
  bind('d','d','vd'); bind('mu','mu','vmu'); bind('s','s','vs'); bind('tau','tau','vtau'); bind('k','k','vk');

  const state=()=>({d:+q('d').value,mu:+q('mu').value,s:+q('s').value,tau:+q('tau').value,k:+q('k').value});
  const apply=o=>{['d','mu','s','tau','k'].forEach(k=>{if(typeof o[k]==='number') q(k).value=o[k]}); ['d','mu','s','tau','k'].forEach(id=>q(id).dispatchEvent(new Event('input')));};

  let timeline=[]; let playId=null; let idx=0;
  const DEFAULT_CSV = [
    '2025-09-01,1.50,2.00,0.60,1.50,1.60',
    '2025-09-02,0.80,0.60,2.00,0.70,0.90',
    '2025-09-03,1.60,1.20,0.50,1.60,1.30',
    '2025-09-04,0.70,2.00,1.80,0.60,1.00'
  ].join('\n');

  const status = msg => { q('now').textContent = msg; };

  function parseCSV(text){
    return text.trim().split(/\n+/).map(line=>{
      const parts = line.split(/\s*,\s*/);
      if (parts.length < 6) return null;
      const [date,d,mu,s,tau,k]=parts;
      const row = {date, d:+d, mu:+mu, s:+s, tau:+tau, k:+k};
      return [row.d,row.mu,row.s,row.tau,row.k].every(v=>!Number.isNaN(v)) ? row : null;
    }).filter(Boolean);
  }

  q('btnLoadCSV').onclick=()=>{
    const txt = q('csv').value.trim();
    const rows = parseCSV(txt);
    if (!rows.length) { status('Could not read CSV. Using example.'); timeline = parseCSV(DEFAULT_CSV); }
    else { timeline = rows; }
    idx = 0;
    status(`${timeline.length} entries loaded`);
  };

  function flash(){ const svg=q('matrixSVG'); svg.style.outline='3px solid rgba(50,111,183,.6)'; setTimeout(()=>svg.style.outline='none',180); }

  function step(){
    if (!timeline.length) { status('No timeline loaded'); return; }
    const row = timeline[idx % timeline.length];
    apply(row);
    status(row.date || `Entry ${idx+1}`);
    flash();
    idx++;
  }

  q('btnPlay').onclick=()=>{
    if (playId) return;
    if (!timeline.length){
      timeline = parseCSV(DEFAULT_CSV); idx=0; status(`${timeline.length} entries loaded (example)`); 
    }
    step();
    const sp = +q('playSpeed').value || 1;
    playId = setInterval(step, 1500 / sp);
  };

  q('btnPause').onclick=()=>{ if (playId){ clearInterval(playId); playId = null; status('Paused'); } };
  window.onbeforeunload = ()=>{ if (playId) clearInterval(playId); };
});
  </script>
</body>
</html>
