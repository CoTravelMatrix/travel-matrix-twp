<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Journey Journal — TWP</title>

  <!-- Meta / Social -->
  <meta name="description" content="My Journey Journal — a calm, purposeful journal for travellers. Science of Travel quietly powers the experience.">
  <meta property="og:title" content="My Journey Journal — TWP">
  <meta property="og:description" content="A simple journal for meaningful travel. The Matrix thinks quietly in the background.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/assets/social-card.jpg">
  <meta name="twitter:card" content="summary_large_image">

  <style>
    /* Type & layout */
    :root{
      --bg:#f6f7f8; --ink:#111; --ink-2:#555; --line:#dcdcdc; --blue:#326FB7;
      --d:1; --mu:1; --s:1; --tau:1; --k:1; /* EMM defaults */
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:11pt/1.5 Calibri, Segoe UI, Roboto, system-ui, -apple-system, Arial, sans-serif;}
    .wrap{max-width:1120px;margin:0 auto;padding:24px;}
    h1,h2,h3{margin:0 0 .5rem 0}
    h1{font-size:1.6rem} h2{font-size:1.2rem} h3{font-size:1rem}
    p,li{color:var(--ink-2)}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:1fr 1fr}
    .muted{color:#777}
    .btn{display:inline-block;border:1px solid var(--line);background:#fff;color:var(--ink);padding:.5rem .75rem;border-radius:8px;text-decoration:none;cursor:pointer}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    nav.tabs{display:flex;gap:8px;margin:12px 0 20px 0;flex-wrap:wrap}
    nav.tabs a{padding:.4rem .65rem;border:1px solid var(--line);border-radius:8px;text-decoration:none;color:var(--ink)}
    nav.tabs a[aria-current="page"]{background:var(--blue);border-color:var(--blue);color:#fff}

    /* Matrix SVG animation — “thinks quietly in the background” */
    .matrix{width:100%;height:auto;display:block}
    .outer{transform-origin:50% 50%;animation:breathe calc(6s / var(--tau)) ease-in-out infinite alternate}
    .petals-cw{transform-origin:50% 50%;animation:spinCW calc(40s / var(--s)) linear infinite}
    .petals-ccw{transform-origin:50% 50%;animation:spinCCW calc(36s / var(--s)) linear infinite}
    .orbit-fast{transform-origin:50% 50%;animation:spinCW calc(18s / var(--s)) linear infinite}
    .orbit-medium{transform-origin:50% 50%;animation:spinCW calc(24s / var(--s)) linear infinite}
    .orbit-slow{transform-origin:50% 50%;animation:spinCW calc(30s / var(--s)) linear infinite}
    .core{transform-origin:50% 50%;animation:pulse calc(2.8s / var(--k)) ease-in-out infinite alternate}
    .traveller{filter:drop-shadow(0 0 calc(1.5px * var(--mu)) rgba(50,111,183,calc(.25 * var(--mu))))}

    @keyframes breathe{from{transform:scale(calc(.98 * var(--d)))} to{transform:scale(calc(1.02 * var(--d)))}}
    @keyframes spinCW{to{transform:rotate(360deg)}}
    @keyframes spinCCW{to{transform:rotate(-360deg)}}
    @keyframes pulse{from{transform:scale(calc(1 + (var(--k) - 1) * .25))} to{transform:scale(calc(1.08 + (var(--k)-1) * .35))}}

    /* Respect OS reduced motion */
    @media (prefers-reduced-motion: reduce){
      .outer,.petals-cw,.petals-ccw,.orbit-fast,.orbit-medium,.orbit-slow,.core{animation:none !important}
    }

    /* Small helpers */
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#eef4fb;color:#224d7a;border-radius:999px;padding:.15rem .5rem;font-size:.85em}
    textarea,input[type="text"]{width:100%;padding:.5rem;border:1px solid var(--line);border-radius:8px}
    input[type="file"]{font-size:.9em}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .thumbs img{width:100%;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
    details>summary{cursor:pointer;font-weight:600;margin:.5rem 0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap grid" style="gap:24px">
    <!-- Header -->
    <header class="grid grid-2" style="align-items:center">
      <div>
        <h1>My Journey Journal</h1>
        <p class="muted">A calm, purposeful journalling app for travellers. The Science of Travel (EMM + Matrix) hums in the background.</p>
      </div>
      <div class="row" style="justify-content:flex-end;">
        <button id="copyLink" class="btn">Copy share link</button>
        <a href="?d=1&mu=1&s=1&tau=1&k=1" class="btn">Balanced</a>
        <a href="?d=1.3&mu=1.0&s=1.2&tau=0.9&k=1.1" class="btn">Explorer</a>
        <a href="?d=1.0&mu=1.4&s=0.9&tau=1.1&k=1.1" class="btn">Connector</a>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="tabs" role="tablist">
      <a href="#today"   id="tab-today"   role="tab" aria-controls="today"   aria-current="page">Today</a>
      <a href="#trips"   id="tab-trips"   role="tab" aria-controls="trips">Trips</a>
      <a href="#gallery" id="tab-gallery" role="tab" aria-controls="gallery">Gallery</a>
    </nav>

    <main class="grid grid-2">
      <!-- Left: Matrix -->
      <section class="card">
        <h2>Living Matrix</h2>
        <p class="muted">Your inner compass rendered as living geometry. Adjusted quietly by your reflections.</p>
        <svg id="matrix" class="matrix" viewBox="0 0 600 600" aria-label="Travel Matrix" style="--d:1;--mu:1;--s:1;--tau:1;--k:1">
          <!-- outer field -->
          <g class="outer">
            <circle cx="300" cy="300" r="280" fill="none" stroke="#326FB7" stroke-width="1.2"/>
          </g>
          <!-- petals -->
          <g class="petals-cw" opacity=".85">
            <!-- six rings -->
            <g transform="rotate(0 300 300)"><circle cx="300" cy="300" r="210" fill="none" stroke="#aeb4b9" stroke-width="1.2"/></g>
            <g transform="rotate(30 300 300)"><circle cx="300" cy="300" r="210" fill="none" stroke="#aeb4b9" stroke-width="1.2"/></g>
            <g transform="rotate(60 300 300)"><circle cx="300" cy="300" r="210" fill="none" stroke="#aeb4b9" stroke-width="1.2"/></g>
            <g transform="rotate(90 300 300)"><circle cx="300" cy="300" r="210" fill="none" stroke="#aeb4b9" stroke-width="1.2"/></g>
            <g transform="rotate(120 300 300)"><circle cx="300" cy="300" r="210" fill="none" stroke="#aeb4b9" stroke-width="1.2"/></g>
            <g transform="rotate(150 300 300)"><circle cx="300" cy="300" r="210" fill="none" stroke="#aeb4b9" stroke-width="1.2"/></g>
          </g>
          <g class="petals-ccw" opacity=".65">
            <g transform="rotate(15 300 300)"><circle cx="300" cy="300" r="170" fill="none" stroke="#326FB7" stroke-width="1.2"/></g>
            <g transform="rotate(45 300 300)"><circle cx="300" cy="300" r="170" fill="none" stroke="#326FB7" stroke-width="1.2"/></g>
            <g transform="rotate(75 300 300)"><circle cx="300" cy="300" r="170" fill="none" stroke="#326FB7" stroke-width="1.2"/></g>
          </g>
          <!-- orbits -->
          <g class="orbit-fast">
            <ellipse cx="300" cy="300" rx="250" ry="150" fill="none" stroke="#111" stroke-width="3" opacity=".9"/>
            <circle cx="550" cy="300" r="10" fill="#111" class="traveller"/>
          </g>
          <g class="orbit-medium">
            <ellipse cx="300" cy="300" rx="230" ry="210" fill="none" stroke="#aeb4b9" stroke-width="2.2"/>
            <circle cx="70"  cy="300" r="10" fill="#111" class="traveller"/>
          </g>
          <g class="orbit-slow">
            <ellipse cx="300" cy="300" rx="120" ry="260" fill="none" stroke="#111" stroke-width="2.2"/>
            <circle cx="420" cy="300" r="10" fill="#111" class="traveller"/>
          </g>
          <!-- core -->
          <g class="core">
            <circle cx="300" cy="300" r="50" fill="#222" opacity=".88"/>
            <circle cx="300" cy="300" r="70" fill="none" stroke="#326FB7" stroke-width="2.2" opacity=".95"/>
          </g>
        </svg>

        <details>
          <summary>Inner Compass (advanced)</summary>
          <div class="grid" style="grid-template-columns:repeat(5,1fr);gap:10px;margin-top:8px">
            <label class="mono">d <input id="d"   type="range" min="0.7" max="1.6" step="0.01"></label>
            <label class="mono">μ <input id="mu"  type="range" min="0.5" max="2.0" step="0.01"></label>
            <label class="mono">s <input id="s"   type="range" min="0.5" max="2.0" step="0.01"></label>
            <label class="mono">τ <input id="tau" type="range" min="0.6" max="1.6" step="0.01"></label>
            <label class="mono">k <input id="k"   type="range" min="0.8" max="1.6" step="0.01"></label>
          </div>
        </details>
      </section>

      <!-- Right: Journal / Trips / Gallery panels -->
      <section class="grid" id="panels">
        <!-- TODAY -->
        <article id="today" class="card" role="tabpanel" aria-labelledby="tab-today">
          <h2>Today</h2>
          <p class="muted">Two silent minutes. Say what mattered. The Matrix will listen.</p>
          <div class="grid">
            <input id="title" type="text" placeholder="Title (e.g. Morning reflection)">
            <input id="tags"  type="text" placeholder="Tags (comma separated): calm, curious, connected">
            <textarea id="note" rows="5" placeholder="What did the day ask of you?"></textarea>
            <div class="row" style="justify-content:flex-end">
              <button id="saveEntry" class="btn primary">Save entry</button>
              <button id="exportJournal" class="btn">Export JSON</button>
            </div>
            <div id="entryHint" class="muted"></div>
            <div id="recent" class="grid"></div>
          </div>
        </article>

        <!-- TRIPS -->
        <article id="trips" class="card" role="tabpanel" aria-labelledby="tab-trips" hidden>
          <h2>Trips</h2>
          <p class="muted">Paste simple CSV: <span class="mono">date, place, activity</span>. Example: <span class="mono">2025-09-01, Athens, Anafiotika wander</span></p>
          <textarea id="tripCsv" rows="6" placeholder="YYYY-MM-DD, Place, Activity"></textarea>
          <div class="row" style="justify-content:flex-end">
            <button id="loadTrips" class="btn primary">Load itinerary</button>
          </div>
          <div id="tripList" class="grid" style="margin-top:10px"></div>
        </article>

        <!-- GALLERY -->
        <article id="gallery" class="card" role="tabpanel" aria-labelledby="tab-gallery" hidden>
          <h2>Gallery</h2>
          <p class="muted">Upload photos to sit alongside your entries. They remain in your browser only.</p>
          <input id="photos" type="file" accept="image/*" multiple />
          <div class="thumbs" id="thumbs" style="margin-top:10px"></div>
        </article>
      </section>
    </main>
  </div>

  <script>
    // ---------- State ----------
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const state = {
      emm: { d:1, mu:1, s:1, tau:1, k:1 },
      entries: JSON.parse(localStorage.getItem('mjj.entries')||'[]'),
      photos:  JSON.parse(localStorage.getItem('mjj.photos')||'[]'), // [{dataURL, date}]
      trips:   JSON.parse(localStorage.getItem('mjj.trips')||'[]')   // [{date, place, activity}]
    };

    // ---------- EMM helpers ----------
    function parseParams(){
      const p = new URLSearchParams(location.search);
      ['d','mu','s','tau','k'].forEach(k=>{
        if(p.has(k)) state.emm[k] = parseFloat(p.get(k));
      });
    }
    function clamp(n,min,max){return Math.max(min, Math.min(max, n));}
    function tagsToEMM(tags, base=state.emm){
      const t = tags.map(x=>x.trim().toLowerCase()).filter(Boolean);
      const bump = (n,a,b)=> clamp(n + a - b, 0.5, 2.0);
      const d   = clamp(base.d   + 0.10*(t.filter(x=>/excited|curious|brave|adventur/i.test(x)).length) - 0.10*(t.filter(x=>/calm|safe|steady/i.test(x)).length), 0.7, 1.6);
      const mu  = clamp(base.mu  + 0.15*(t.filter(x=>/grateful|connected|purpose|meaning|inspir/i.test(x)).length), 0.5, 2.0);
      const s   = clamp(base.s   + 0.10*(t.filter(x=>/energetic|active|busy|fast/i.test(x)).length) - 0.10*(t.filter(x=>/tired|slow|still|restful/i.test(x)).length), 0.5, 2.0);
      const tau = clamp(base.tau + 0.10*(t.filter(x=>/calm|patient|peaceful|centred|balanced/i.test(x)).length) - 0.15*(t.filter(x=>/stressed|anxious|overwhelm|rushed/i.test(x)).length), 0.6, 1.6);
      const k   = clamp(base.k   + 0.10*(t.filter(x=>/focused|determined|clear|intentional|directed/i.test(x)).length) - 0.10*(t.filter(x=>/confused|lost|uncertain|scattered/i.test(x)).length), 0.8, 1.6);
      return {d,mu,s,tau,k};
    }
    function applyEMM(emm){
      state.emm = emm;
      const r = document.documentElement;
      Object.entries(emm).forEach(([k,v])=> r.style.setProperty('--'+k, v));
    }

    // ---------- Matrix controls ----------
    function wireInnerCompass(){
      ['d','mu','s','tau','k'].forEach(k=>{
        const input = $('#'+k);
        input.value = state.emm[k];
        input.addEventListener('input', ()=>{
          const next = {...state.emm, [k]: parseFloat(input.value)};
          applyEMM(next);
          history.replaceState(null,'', location.pathname + '?' + new URLSearchParams(next).toString());
        });
      });
    }

    // ---------- Journal ----------
    function saveEntry(){
      const title = $('#title').value.trim();
      const note  = $('#note').value.trim();
      const tags  = $('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);
      if(!title && !note){ $('#entryHint').textContent = 'Write a line first.'; return; }

      const emmFromTags = tags.length ? tagsToEMM(tags, state.emm) : state.emm;
      applyEMM(emmFromTags);

      const entry = {
        id: Date.now(),
        date: new Date().toISOString().slice(0,10),
        title, note, tags,
        emm: {...state.emm}
      };
      state.entries.unshift(entry);
      localStorage.setItem('mjj.entries', JSON.stringify(state.entries));
      $('#entryHint').textContent = 'Saved locally. Private to this browser.';
      $('#title').value=''; $('#note').value=''; $('#tags').value='';
      renderRecent();
    }
    function renderRecent(){
      const box = $('#recent');
      if(state.entries.length===0){ box.innerHTML=''; return; }
      box.innerHTML = state.entries.slice(0,5).map(e=>`
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>${e.title||'Untitled'}</strong>
            <span class="muted">${e.date}</span>
          </div>
          <p>${e.note ? e.note.replace(/</g,'&lt;') : ''}</p>
          <div class="chips">${(e.tags||[]).map(t=>`<span class="chip">${t}</span>`).join('')}</div>
          <div class="muted mono">EMM: d ${e.emm.d.toFixed(2)} · μ ${e.emm.mu.toFixed(2)} · s ${e.emm.s.toFixed(2)} · τ ${e.emm.tau.toFixed(2)} · k ${e.emm.k.toFixed(2)}</div>
        </div>
      `).join('');
    }
    function exportJournal(){
      const blob = new Blob([JSON.stringify({entries:state.entries, trips:state.trips, exported:new Date().toISOString()}, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `my-journey-journal-${new Date().toISOString().slice(0,10)}.json`;
      a.click(); URL.revokeObjectURL(a.href);
    }

    // ---------- Trips ----------
    function loadTrips(){
      const text = $('#tripCsv').value.trim();
      if(!text){ $('#tripList').innerHTML='<p class="muted">Paste a few lines first.</p>'; return; }
      const rows = text.split('\n').map(l=>l.split(',').map(s=>s.trim()));
      const items = rows.filter(r=>r.length>=2).map(r=>({date:r[0], place:r[1], activity:r[2]||''}));
      state.trips = items;
      localStorage.setItem('mjj.trips', JSON.stringify(state.trips));
      renderTrips();
    }
    function renderTrips(){
      const box = $('#tripList');
      if(state.trips.length===0){ box.innerHTML=''; return; }
      box.innerHTML = state.trips.map(t=>`
        <div class="row" style="justify-content:space-between;border-bottom:1px solid var(--line);padding:6px 0">
          <div><strong>${t.date}</strong> — ${t.place}${t.activity?': '+t.activity:''}</div>
          <div class="chips"><span class="chip">itinerary</span></div>
        </div>
      `).join('');
    }

    // ---------- Gallery ----------
    function handlePhotos(ev){
      const files = Array.from(ev.target.files||[]);
      if(files.length===0) return;
      const readAll = files.map(f=> new Promise(res=>{
        const fr = new FileReader();
        fr.onload = ()=> res({dataURL: fr.result, date: new Date().toISOString().slice(0,10), name: f.name});
        fr.readAsDataURL(f);
      }));
      Promise.all(readAll).then(list=>{
        state.photos.unshift(...list);
        localStorage.setItem('mjj.photos', JSON.stringify(state.photos));
        renderThumbs();
      });
      ev.target.value = '';
    }
    function renderThumbs(){
      const g = $('#thumbs');
      if(state.photos.length===0){ g.innerHTML=''; return; }
      g.innerHTML = state.photos.map(p=>`<figure><img src="${p.dataURL}" alt="Photo"><figcaption class="muted" style="font-size:.8em">${p.name}</figcaption></figure>`).join('');
    }

    // ---------- Tabs ----------
    function wireTabs(){
      const tabs = [['today','#tab-today'],['trips','#tab-trips'],['gallery','#tab-gallery']];
      tabs.forEach(([id,btn])=>{
        $(btn).addEventListener('click', e=>{
          e.preventDefault();
          tabs.forEach(([tid,tbtn])=>{
            $('#'+tid).hidden = (tid!==id);
            $(tbtn).setAttribute('aria-current', tid===id ? 'page' : 'false');
          });
          history.replaceState(null,'', location.pathname + location.search + '#'+id);
        });
      });
      // open deep link
      const hash = location.hash.replace('#','');
      if(['today','trips','gallery'].includes(hash)) $( '#tab-'+hash ).click();
    }

    // ---------- Share link ----------
    function copyShare(){
      const url = location.origin + location.pathname + '?' + new URLSearchParams(state.emm).toString();
      navigator.clipboard.writeText(url).then(()=>{$('#copyLink').textContent='Link copied'; setTimeout(()=>$('#copyLink').textContent='Copy share link',1200);});
    }

    // ---------- Init ----------
    parseParams();
    applyEMM(state.emm);
    wireInnerCompass(); wireTabs();
    renderRecent(); renderTrips(); renderThumbs();

    $('#saveEntry').addEventListener('click', saveEntry);
    $('#exportJournal').addEventListener('click', exportJournal);
    $('#loadTrips').addEventListener('click', loadTrips);
    $('#photos').addEventListener('change', handlePhotos);
    $('#copyLink').addEventListener('click', copyShare);
  </script>
</body>
</html>
