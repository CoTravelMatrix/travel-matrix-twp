<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Travel Matrix — TWP (Travel With Purpose)</title>
<style>
  :root{ --blue:#326FB7; --ink:#111; --paper:#F6F7F8; --line:#E7EAEE;
         --d:1; --mu:1; --s:1; --tau:1; --k:1; }
  html,body{margin:0;background:var(--paper);font:11pt Calibri, Arial, sans-serif;color:var(--ink)}
  .wrap{max-width:980px;margin:24px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:980px){.grid{grid-template-columns:620px 1fr}}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.07)}
  .pad{padding:14px}
  h1{font-size:18px;margin:0 0 6px} h2{font-size:14px;margin:12px 0 8px}
  .small{font-size:12px;color:#47515a}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .ctrl{border:1px solid var(--line);border-radius:12px;padding:12px}
  label{display:block;font-weight:600;margin:0 0 2px}
  input[type=range]{width:100%}
  .btn{cursor:pointer;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .btn:hover{box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .btn.blue{border-color:var(--blue);color:#fff;background:var(--blue)}
  .stack{display:flex;flex-wrap:wrap;gap:8px}
  .input{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;font:inherit}
  .right{display:flex;justify-content:flex-end;gap:8px}
  details summary{cursor:pointer;font-weight:600}

  @keyframes breathe {from{transform:scale(calc(0.98*var(--d)))} to{transform:scale(calc(1.02*var(--d)))}} 
  @keyframes rotateCW {to{transform:rotate(360deg)}}
  @keyframes rotateCCW {to{transform:rotate(-360deg)}}
  @keyframes pulseCore {from{transform:scale(calc(1 + (var(--k)-1)*0.25))} to{transform:scale(calc(1.08 + (var(--k)-1)*0.35))}}
  @keyframes orbit {to{transform:rotate(360deg)}}

  .stage{width:100%;display:block}
  .outer{transform-origin:50% 50%;animation:breathe calc(6s/var(--tau)) ease-in-out infinite alternate}
  .petalsCW{transform-origin:50% 50%;animation:rotateCW calc(40s/var(--s)) linear infinite}
  .petalsCCW{transform-origin:50% 50%;animation:rotateCCW calc(36s/var(--s)) linear infinite}
  .orbit{transform-origin:50% 50%;animation:orbit calc(24s/var(--s)) linear infinite}
  .orbit.slow{animation-duration:calc(30s/var(--s))}
  .orbit.fast{animation-duration:calc(18s/var(--s))}
  .corePulse{transform-origin:50% 50%;animation:pulseCore 2.8s ease-in-out infinite alternate}
  .traveller{filter:drop-shadow(0 0 calc(1.5px*var(--mu)) rgba(50,111,183,.25))}
  .noFill{fill:none} .thin{stroke-width:1.2} .med{stroke-width:2.2} .thic{stroke-width:3}
  .ink{stroke:#111} .mid{stroke:#aeb4b9} .blue{stroke:#326FB7}
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <!-- Matrix -->
      <div class="card pad">
        <h1>Travel Matrix — TWP</h1>
        <div class="small">EMM-driven animation: Distance (d), Meaning (μ), Speed (s), Time/Patience (τ), Intention (k).</div>

        <svg id="matrixSVG" class="stage" viewBox="0 0 600 600" aria-label="Travel Matrix">
          <g class="outer"><circle cx="300" cy="300" r="280" class="noFill blue thin"/></g>
          <g class="petalsCW mid thin noFill" opacity="0.85">
            <circle cx="300" cy="300" r="210"/>
            <g transform="rotate(30,300,300)"><circle cx="300" cy="300" r="210"/></g>
            <g transform="rotate(60,300,300)"><circle cx="300" cy="300" r="210"/></g>
            <g transform="rotate(90,300,300)"><circle cx="300" cy="300" r="210"/></g>
            <g transform="rotate(120,300,300)"><circle cx="300" cy="300" r="210"/></g>
            <g transform="rotate(150,300,300)"><circle cx="300" cy="300" r="210"/></g>
          </g>
          <g class="petalsCCW blue thin noFill" opacity="0.65">
            <g transform="rotate(15,300,300)"><circle cx="300" cy="300" r="170"/></g>
            <g transform="rotate(45,300,300)"><circle cx="300" cy="300" r="170"/></g>
            <g transform="rotate(75,300,300)"><circle cx="300" cy="300" r="170"/></g>
          </g>
          <g class="orbit fast">
            <ellipse cx="300" cy="300" rx="250" ry="150" class="noFill ink thic" opacity="0.9"/>
            <circle cx="550" cy="300" r="10" class="traveller" fill="#111"/>
          </g>
          <g class="orbit">
            <ellipse cx="300" cy="300" rx="230" ry="210" class="noFill mid med"/>
            <circle cx="70" cy="300" r="10" class="traveller" fill="#111"/>
          </g>
          <g class="orbit slow">
            <ellipse cx="300" cy="300" rx="120" ry="260" class="noFill ink med"/>
            <circle cx="420" cy="300" r="10" class="traveller" fill="#111"/>
          </g>
          <g class="corePulse">
            <circle cx="300" cy="300" r="50" fill="#222" opacity="0.88"/>
            <circle cx="300" cy="300" r="70" class="noFill blue med" opacity="0.95"/>
          </g>
        </svg>

        <div class="right" style="margin-top:10px">
          <button id="btnSnapshot" class="btn">Snapshot PNG</button>
          <button id="btnShare" class="btn">Copy Share Link</button>
          <button id="btnReset" class="btn">Reset</button>
        </div>
      </div>

      <!-- Controls -->
      <div class="card pad">
        <h2>EMM Controls</h2>
        <div class="row">
          <div class="ctrl">
            <label>Distance (d): <span id="vd" class="small">1.00</span></label>
            <input id="d" type="range" min="0.7" max="1.6" step="0.01" value="1" />
            <label>Meaning (μ): <span id="vmu" class="small">1.00</span></label>
            <input id="mu" type="range" min="0.5" max="2.0" step="0.01" value="1" />
            <label>Speed (s): <span id="vs" class="small">1.00</span></label>
            <input id="s" type="range" min="0.5" max="2.0" step="0.01" value="1" />
          </div>
          <div class="ctrl">
            <label>Time / Patience (τ): <span id="vtau" class="small">1.00</span></label>
            <input id="tau" type="range" min="0.6" max="1.6" step="0.01" value="1" />
            <label>Intention (k): <span id="vk" class="small">1.00</span></label>
            <input id="k" type="range" min="0.8" max="1.6" step="0.01" value="1" />
            <div class="small" style="margin-top:6px">
              Higher <b>d</b> breathes the field; higher <b>μ</b> brightens traveller glow;
              higher <b>s</b> speeds rotation; higher <b>τ</b> smooths wobble; higher <b>k</b> strengthens the core pulse.
            </div>
          </div>
        </div>

        <h2>Presets</h2>
        <div class="stack" style="margin-bottom:8px">
          <button class="btn" data-preset="Balanced">Balanced</button>
          <button class="btn" data-preset="Explorer">Explorer</button>
          <button class="btn" data-preset="Connector">Connector</button>
          <button class="btn" data-preset="Transcend">Transcend</button>
        </div>
        <div class="row" style="align-items:center">
          <input id="presetName" class="input" placeholder="Preset name" />
          <div class="right"><button id="btnSavePreset" class="btn">Save Preset</button><button id="btnLoadPreset" class="btn">Load Presets</button></div>
        </div>

        <details style="margin-top:12px">
          <summary>Timeline (paste CSV – date,d,mu,s,tau,k)</summary>
          <div class="small" style="margin:6px 0">Example:<br>2025-09-01,1.2,1.4,0.9,1.1,1.3</div>
          <textarea id="csv" class="input" rows="6" placeholder="date,d,mu,s,tau,k"></textarea>
          <div class="stack" style="margin-top:8px">
            <button id="btnLoadCSV" class="btn">Load Timeline</button>
            <button id="btnPlay" class="btn blue">Play</button>
            <button id="btnPause" class="btn">Pause</button>
            <label class="small">Speed <input id="playSpeed" type="range" min="0.2" max="2" value="1" step="0.1"></label>
            <div class="small" id="now"></div>
          </div>
        </details>
      </div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', function () {
  const setVar = (name, val) => document.documentElement.style.setProperty(name, val);
  const fmt = x => Number(x).toFixed(2);
  const q = id => document.getElementById(id);

  function bind(id, cssVar, labelId){
    const el = q(id), lab = q(labelId);
    const update = () => { setVar(`--${cssVar}`, el.value); lab.textContent = fmt(el.value); saveState(); };
    el.addEventListener('input', update); update();
  }
  bind('d','d','vd'); bind('mu','mu','vmu'); bind('s','s','vs'); bind('tau','tau','vtau'); bind('k','k','vk');

  // Presets
  const KEY='twmatrix.presets.v1';
  const defaults={Balanced:{d:1,mu:1,s:1,tau:1,k:1},Explorer:{d:1.3,mu:1.0,s:1.2,tau:0.9,k:1.1},Connector:{d:1.0,mu:1.4,s:0.9,tau:1.1,k:1.1},Transcend:{d:0.95,mu:1.2,s:0.8,tau:1.3,k:1.25}};
  const loadAll=()=>{try{return JSON.parse(localStorage.getItem(KEY))||{}}catch(e){return{}}};
  const saveAll=o=>localStorage.setItem(KEY,JSON.stringify(o));
  const state=()=>({d:+q('d').value,mu:+q('mu').value,s:+q('s').value,tau:+q('tau').value,k:+q('k').value});
  const apply=o=>{['d','mu','s','tau','k'].forEach(k=>{if(typeof o[k]==='number') q(k).value=o[k]}); ['d','mu','s','tau','k'].forEach(id=>q(id).dispatchEvent(new Event('input')));};

  document.querySelectorAll('[data-preset]').forEach(b=>b.onclick=()=>{const name=b.dataset.preset;apply(loadAll()[name]||defaults[name])});
  q('btnSavePreset').onclick=()=>{const name=(q('presetName').value||'').trim();if(!name)return alert('Name your preset.');const all=loadAll();all[name]=state();saveAll(all);alert('Saved preset: '+name)};
  q('btnLoadPreset').onclick=()=>{const all=Object.assign({},defaults,loadAll());const pick=prompt('Type a preset name to load:\n'+Object.keys(all).join(', ')); if(pick&&all[pick]) apply(all[pick]);};

  // URL share
  function toQuery(s){return '?'+new URLSearchParams(s).toString()}
  function fromQuery(){const p=new URLSearchParams(location.search);const s={};['d','mu','s','tau','k'].forEach(k=>{if(p.has(k)) s[k]=+p.get(k)});return Object.keys(s).length?s:null}
  function saveState(){ history.replaceState(null,'', toQuery(state())); }
  const qs=fromQuery(); if(qs) apply(qs);
  q('btnShare').onclick=()=>{ const link=location.origin+location.pathname+toQuery(state()); navigator.clipboard.writeText(link).then(()=>alert('Share link copied.')); };

  // Snapshot
  q('btnSnapshot').onclick=()=>{ const svg=q('matrixSVG'); const s=new XMLSerializer().serializeToString(svg);
    const blob=new Blob([s],{type:'image/svg+xml;charset=utf-8'}); const url=URL.createObjectURL(blob);
    const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'); c.width=1200; c.height=1200;
      const x=c.getContext('2d'); x.fillStyle=getComputedStyle(document.body).backgroundColor; x.fillRect(0,0,1200,1200);
      x.drawImage(img,0,0,1200,1200); c.toBlob(b=>{const a=document.createElement('a'); a.download='travel-matrix.png'; a.href=URL.createObjectURL(b); a.click(); URL.revokeObjectURL(url);},'image/png'); };
    img.src=url; };

  // Reset
  q('btnReset').onclick=()=>apply({d:1,mu:1,s:1,tau:1,k:1});

  // Timeline (robust + visible)
  let timeline=[]; let playId=null; let idx=0;

  const DEFAULT_CSV = [
    '2025-09-01,1.50,2.00,0.60,1.50,1.60',
    '2025-09-02,0.80,0.60,2.00,0.70,0.90',
    '2025-09-03,1.60,1.20,0.50,1.60,1.30',
    '2025-09-04,0.70,2.00,1.80,0.60,1.00'
  ].join('\n');

  const status = msg => { q('now').textContent = msg; };

  function parseCSV(text){
    return text.trim().split(/\n+/).map(line=>{
      const parts = line.split(/\s*,\s*/);
      if (parts.length < 6) return null;
      const [date,d,mu,s,tau,k]=parts;
      const row = {date, d:+d, mu:+mu, s:+s, tau:+tau, k:+k};
      return [row.d,row.mu,row.s,row.tau,row.k].every(v=>!Number.isNaN(v)) ? row : null;
    }).filter(Boolean);
  }

  q('btnLoadCSV').onclick=()=>{
    const txt = q('csv').value.trim();
    const rows = parseCSV(txt);
    if (!rows.length) { status('Could not read CSV. Using example.'); timeline = parseCSV(DEFAULT_CSV); }
    else { timeline = rows; }
    idx = 0;
    status(`${timeline.length} entries loaded`);
  };

  function flash(){ const svg=q('matrixSVG'); svg.style.outline='3px solid rgba(50,111,183,.6)'; setTimeout(()=>svg.style.outline='none',180); }

  function step(){
    if (!timeline.length) { status('No timeline loaded'); return; }
    const row = timeline[idx % timeline.length];
    apply(row);
    status(row.date || `Entry ${idx+1}`);
    flash();
    idx++;
  }

  q('btnPlay').onclick=()=>{
    if (playId) return;
    if (!timeline.length){ timeline = parseCSV(DEFAULT_CSV); idx=0; status(`${timeline.length} entries loaded (example)`); }
    step();
    const sp = +q('playSpeed').value || 1;
    playId = setInterval(step, 1500 / sp);
  };

  q('btnPause').onclick=()=>{ if (playId){ clearInterval(playId); playId=null; status('Paused'); } };
});
</script>
</body>
</html>
