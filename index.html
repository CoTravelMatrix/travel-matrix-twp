<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Travel Matrix — Timeline Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --d: 1;
      --mu: 1;
      --s: 1;
      --tau: 1;
      --k: 1;
    }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:20px; color:#111; }
    h2 { margin:0 0 12px 0; }
    .tool-row { margin:10px 0; }
    textarea { font-family: monospace; width:640px; max-width:100%; }
    #matrixSVG { width: 640px; max-width:100%; height: 420px; border:1px solid #ddd; background: linear-gradient(#fff,#f9f9fb); display:block; }
    input[type=range] { vertical-align: middle; }
    .preset-btn { margin-right:6px; }
    #now { margin-top:10px; font-weight:600; color:#135; }
    .legend { font-size:12px; color:#444; margin-top:6px; }
  </style>
</head>
<body>
  <h2>Travel Matrix Timeline Test</h2>

  <div class="tool-row">
    <textarea id="csv" rows="5" cols="60" placeholder="Paste your timeline CSV data here"></textarea><br>
    <button id="btnLoadCSV">Load CSV</button>
    <button id="btnPlay">Play</button>
    <button id="btnPause">Pause</button>
    Speed: <input id="playSpeed" type="number" value="1" min="1" max="5" style="width:64px">
  </div>

  <svg id="matrixSVG" viewBox="0 0 800 520" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Travel matrix visualization"></svg>

  <div class="tool-row">
    <label>D: <input id="d" type="range" min="0" max="2" step="0.01"><span id="vd"></span></label>
    &nbsp; <label>Mu: <input id="mu" type="range" min="0" max="2" step="0.01"><span id="vmu"></span></label>
    &nbsp; <label>S: <input id="s" type="range" min="0" max="2" step="0.01"><span id="vs"></span></label>
    &nbsp; <label>Tau: <input id="tau" type="range" min="0" max="2" step="0.01"><span id="vtau"></span></label>
    &nbsp; <label>K: <input id="k" type="range" min="0" max="2" step="0.01"><span id="vk"></span></label>
  </div>

  <div class="tool-row">
    <button data-preset="Balanced" class="preset-btn">Balanced</button>
    <button data-preset="Explorer" class="preset-btn">Explorer</button>
    <button data-preset="Connector" class="preset-btn">Connector</button>
    <button data-preset="Transcend" class="preset-btn">Transcend</button>
    <input id="presetName" type="text" placeholder="Custom preset name">
    <button id="btnSavePreset">Save Preset</button>
    <button id="btnLoadPreset">Load Preset</button>
  </div>

  <div class="tool-row">
    <button id="btnShare">Share Link</button>
    <button id="btnSnapshot">Snapshot</button>
    <button id="btnReset">Reset</button>
  </div>

  <div id="now"></div>
  <div class="legend">Visualization: nodes = groups, node size ↔ S, stroke ↔ D, color ↔ K, link opacity ↔ Mu/Tau.</div>

  <!-- ======= Your robust script (kept unchanged) ======= -->
  <script>
window.addEventListener('DOMContentLoaded', function () {
  const setVar = (name, val) => document.documentElement.style.setProperty(name, val);
  const fmt = x => Number(x).toFixed(2);
  const q = id => document.getElementById(id);

  // Bind sliders -> CSS vars
  function bind(id, cssVar, labelId){
    const el=q(id), lab=q(labelId);
    const update=()=>{ setVar(`--${cssVar}`, el.value); lab.textContent=fmt(el.value); saveState(); };
    el.addEventListener('input', update); update();
  }
  bind('d','d','vd'); bind('mu','mu','vmu'); bind('s','s','vs'); bind('tau','tau','vtau'); bind('k','k','vk');

  // Presets
  const KEY='twmatrix.presets.v1';
  const defaults={Balanced:{d:1,mu:1,s:1,tau:1,k:1},Explorer:{d:1.3,mu:1.0,s:1.2,tau:0.9,k:1.1},Connector:{d:1.0,mu:1.4,s:0.9,tau:1.1,k:1.1},Transcend:{d:0.95,mu:1.2,s:0.8,tau:1.3,k:1.25}};
  const loadAll=()=>{try{return JSON.parse(localStorage.getItem(KEY))||{}}catch(e){return{}}};
  const saveAll=o=>localStorage.setItem(KEY,JSON.stringify(o));
  const state=()=>({d:+q('d').value,mu:+q('mu').value,s:+q('s').value,tau:+q('tau').value,k:+q('k').value});
  const apply=o=>{['d','mu','s','tau','k'].forEach(k=>{if(typeof o[k]==='number') q(k).value=o[k]}); ['d','mu','s','tau','k'].forEach(id=>q(id).dispatchEvent(new Event('input')));};
  document.querySelectorAll('[data-preset]').forEach(b=>b.onclick=()=>apply(loadAll()[b.dataset.preset]||defaults[b.dataset.preset]));
  q('btnSavePreset').onclick=()=>{const name=(q('presetName').value||'').trim(); if(!name) return alert('Name your preset.'); const all=loadAll(); all[name]=state(); saveAll(all); alert('Saved preset: '+name);};
  q('btnLoadPreset').onclick=()=>{const all=Object.assign({},defaults,loadAll()); const pick=prompt('Type a preset name:\n'+Object.keys(all).join(', ')); if(pick&&all[pick]) apply(all[pick]);};

  // URL share
  function toQuery(s){return '?'+new URLSearchParams(s).toString()}
  function fromQuery(){const p=new URLSearchParams(location.search); const s={}; ['d','mu','s','tau','k'].forEach(k=>{if(p.has(k)) s[k]=+p.get(k)}); return Object.keys(s).length?s:null;}
  function saveState(){ history.replaceState(null,'', toQuery(state())); }
  const qs=fromQuery(); if(qs) apply(qs);
  q('btnShare').onclick=()=>{ const link=location.origin+location.pathname+toQuery(state()); navigator.clipboard.writeText(link).then(()=>alert('Share link copied.')); };

  // Snapshot
  q('btnSnapshot').onclick=()=>{ const svg=q('matrixSVG'); const s=new XMLSerializer().serializeToString(svg);
    const blob=new Blob([s],{type:'image/svg+xml;charset=utf-8'}); const url=URL.createObjectURL(blob);
    const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'); c.width=1200; c.height=1200;
      const x=c.getContext('2d'); x.fillStyle=getComputedStyle(document.body).backgroundColor; x.fillRect(0,0,1200,1200);
      x.drawImage(img,0,0,1200,1200); c.toBlob(b=>{const a=document.createElement('a'); a.download='travel-matrix.png'; a.href=URL.createObjectURL(b); a.click(); URL.revokeObjectURL(url);},'image/png'); };
    img.src=url; };

  // Reset
  q('btnReset').onclick=()=>apply({d:1,mu:1,s:1,tau:1,k:1});

  // ===== Timeline: robust, visible, fool-proof =====
  let timeline=[]; let playId=null; let idx=0;

  // Provide a default CSV so Play "works" even with nothing pasted
  const DEFAULT_CSV = [
    '2025-09-01,1.50,2.00,0.60,1.50,1.60',
    '2025-09-02,0.80,0.60,2.00,0.70,0.90',
    '2025-09-03,1.60,1.20,0.50,1.60,1.30',
    '2025-09-04,0.70,2.00,1.80,0.60,1.00'
  ].join('\n');

  const status = msg => { q('now').textContent = msg; };

  function parseCSV(text){
    return text.trim().split(/\n+/).map(line=>{
      const parts = line.split(/\s*,\s*/);
      if (parts.length < 6) return null;
      const [date,d,mu,s,tau,k]=parts;
      const row = {date, d:+d, mu:+mu, s:+s, tau:+tau, k:+k};
      return [row.d,row.mu,row.s,row.tau,row.k].every(v=>!Number.isNaN(v)) ? row : null;
    }).filter(Boolean);
  }

  q('btnLoadCSV').onclick=()=>{
    const txt = q('csv').value.trim();
    const rows = parseCSV(txt);
    if (!rows.length) { status('Could not read CSV. Using example.'); timeline = parseCSV(DEFAULT_CSV); }
    else { timeline = rows; }
    idx = 0;
    status(`${timeline.length} entries loaded`);
  };

  function flash(){ const svg=q('matrixSVG'); svg.style.outline='3px solid rgba(50,111,183,.6)'; setTimeout(()=>svg.style.outline='none',180); }

  function step(){
    if (!timeline.length) { status('No timeline loaded'); return; }
    const row = timeline[idx % timeline.length];
    apply(row);
    status(row.date || `Entry ${idx+1}`);
    flash();
    idx++;
  }

  q('btnPlay').onclick=()=>{
    if (playId) return;
    if (!timeline.length){ // auto-load default if empty
      timeline = parseCSV(DEFAULT_CSV); idx=0; status(`${timeline.length} entries loaded (example)`); 
    }
    step();
    const sp = +q('playSpeed').value || 1;
    playId = setInterval(step, 1500 / sp);
  };

  q('btnPause').onclick=()=>{ if (playId){ clearInterval(playId); playId = null; status('Paused'); } };
});
  </script>

  <!-- ======= Rendering layer (keeps your script unchanged, updates the SVG visuals) ======= -->
  <script>
  (function(){
    const svg = document.getElementById('matrixSVG');

    // Create a group for visuals
    function clearSVG() {
      while (svg.firstChild) svg.removeChild(svg.firstChild);
    }

    // Utility: read current parameter state
    function getParams() {
      const d = +document.getElementById('d').value;
      const mu = +document.getElementById('mu').value;
      const s = +document.getElementById('s').value;
      const tau = +document.getElementById('tau').value;
      const k = +document.getElementById('k').value;
      return {d,mu,s,tau,k};
    }

    // Draw a simple illustrative travel-matrix visualization:
    // - 5 nodes in a pentagon; node radius ~ s
    // - stroke width ~ d
    // - color hue ~ k
    // - link opacity & thickness ~ mu/tau
    // - center heat grid representing parameter intensities
    function renderMatrix(){
      const p = getParams();
      clearSVG();

      // background grid
      const grid = document.createElementNS('http://www.w3.org/2000/svg','g');
      grid.setAttribute('opacity','0.06');
      for(let i=0;i<10;i++){
        const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
        r.setAttribute('x',40 + i*70);
        r.setAttribute('y',60);
        r.setAttribute('width',60);
        r.setAttribute('height',380);
        r.setAttribute('fill','#66a');
        r.setAttribute('transform','rotate(6 40 60)');
        r.setAttribute('rx',8);
        grid.appendChild(r);
      }
      svg.appendChild(grid);

      // center heat square showing combined intensity
      const heat = document.createElementNS('http://www.w3.org/2000/svg','rect');
      heat.setAttribute('x',520); heat.setAttribute('y',40);
      heat.setAttribute('width',240); heat.setAttribute('height',220);
      const combined = Math.min(1, (p.s*0.25 + p.k*0.2 + p.mu*0.2 + p.d*0.2 + p.tau*0.15) / 1.5);
      const hue = 215 - (p.k-1)*60; // k changes hue
      heat.setAttribute('fill', `hsl(${hue} ${40 + combined*40}% ${65 - combined*25}%)`);
      heat.setAttribute('stroke','#234'); heat.setAttribute('stroke-opacity','0.08'); heat.setAttribute('rx','8');
      svg.appendChild(heat);

      // nodes in a pentagon
      const cx = 300, cy = 260, r = 160;
      const nodes = [];
      for(let i=0;i<5;i++){
        const ang = -Math.PI/2 + (i * Math.PI*2 / 5);
        const x = cx + r*Math.cos(ang);
        const y = cy + r*Math.sin(ang);
        nodes.push({x,y});
      }

      // links
      const links = document.createElementNS('http://www.w3.org/2000/svg','g');
      const linkOpacity = Math.min(1, Math.max(0.08, (p.mu / (p.tau||1))));
      const linkWidth = 1 + (p.mu * 2 / (p.tau||1));
      for(let i=0;i<nodes.length;i++){
        for(let j=i+1;j<nodes.length;j++){
          const L = document.createElementNS('http://www.w3.org/2000/svg','line');
          L.setAttribute('x1',nodes[i].x); L.setAttribute('y1',nodes[i].y);
          L.setAttribute('x2',nodes[j].x); L.setAttribute('y2',nodes[j].y);
          L.setAttribute('stroke',`rgba(20,50,80,${0.12 + 0.6*linkOpacity})`);
          L.setAttribute('stroke-width', Math.max(0.6, linkWidth));
          L.setAttribute('stroke-linecap','round');
          links.appendChild(L);
        }
      }
      svg.appendChild(links);

      // draw nodes
      const nodesG = document.createElementNS('http://www.w3.org/2000/svg','g');
      nodesG.setAttribute('stroke-linejoin','round');
      for(let i=0;i<nodes.length;i++){
        const n = nodes[i];
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('transform', `translate(${n.x},${n.y})`);
        // node halo
        const halo = document.createElementNS('http://www.w3.org/2000/svg','circle');
        halo.setAttribute('r', 30 + p.s*10);
        halo.setAttribute('fill', `rgba(60,140,220,${0.06 + (p.k-0.5)*0.08})`);
        g.appendChild(halo);
        // main circle
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        const radius = 12 + p.s*8;
        c.setAttribute('r', radius);
        const hue = 210 - (p.k-1)*60;
        c.setAttribute('fill', `hsl(${hue} ${50 + (p.k-1)*20}% ${58 - (p.s-1)*6}%)`);
        c.setAttribute('stroke', `rgba(8,24,48,${0.55 + (p.d-1)*0.15})`);
        c.setAttribute('stroke-width', Math.max(0.8, p.d*1.5));
        g.appendChild(c);
        // label
        const label = document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('y', radius + 18);
        label.setAttribute('x', 0);
        label.setAttribute('text-anchor','middle');
        label.setAttribute('font-size','12');
        label.setAttribute('fill','#123');
        label.textContent = ['A','B','C','D','E'][i];
        g.appendChild(label);

        nodesG.appendChild(g);
      }
      svg.appendChild(nodesG);

      // parameter readouts in SVG
      const infoG = document.createElementNS('http://www.w3.org/2000/svg','g');
      infoG.setAttribute('transform','translate(520,280)');
      const params = ['D','Mu','S','Tau','K'];
      const vals = [p.d,p.mu,p.s,p.tau,p.k];
      for(let i=0;i<5;i++){
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('y', i*18);
        t.setAttribute('font-size','13');
        t.setAttribute('fill','#222');
        t.textContent = `${params[i]}: ${vals[i].toFixed(2)}`;
        infoG.appendChild(t);
      }
      svg.appendChild(infoG);

      // subtle footer timestamp
      const foot = document.createElementNS('http://www.w3.org/2000/svg','text');
      foot.setAttribute('x', 520);
      foot.setAttribute('y', 520-10);
      foot.setAttribute('font-size','11');
      foot.setAttribute('fill','#666');
      foot.textContent = `visual updated: ${new Date().toLocaleString()}`;
      svg.appendChild(foot);
    }

    // Wire up: update on any slider input + when timeline steps apply (apply dispatches input events)
    ['d','mu','s','tau','k'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', renderMatrix);
    });

    // Also update when presets, load, play do their thing.
    document.getElementById('btnLoadCSV').addEventListener('click', ()=>setTimeout(renderMatrix,60));
    document.getElementById('btnPlay').addEventListener('click', ()=>setTimeout(renderMatrix,60));
    document.getElementById('btnPause').addEventListener('click', ()=>setTimeout(renderMatrix,60));

    // initial render (sliders have been bound by user's script and initial update called in bind)
    setTimeout(renderMatrix, 70);

    // Re-render every second while playing to keep visuals in sync
    let renderTicker = null;
    const startRenderTicker = ()=>{ if(renderTicker) return; renderTicker = setInterval(renderMatrix, 900); };
    const stopRenderTicker = ()=>{ if(renderTicker){ clearInterval(renderTicker); renderTicker = null; } };
    document.getElementById('btnPlay').addEventListener('click', startRenderTicker);
    document.getElementById('btnPause').addEventListener('click', stopRenderTicker);
    window.addEventListener('beforeunload', stopRenderTicker);
  })();
  </script>
</body>
</html>
